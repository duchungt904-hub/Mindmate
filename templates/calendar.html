{% extends "base.html" %}

{% block title %}æ—¥å† - MindMate{% endblock %}

{% block content %}
<div class="container" style="padding-bottom: 80px;">
    <div class="calendar-header">
        <button id="prevMonth" class="btn-nav">â—€</button>
        <h1 id="monthYear"></h1>
        <button id="nextMonth" class="btn-nav">â–¶</button>
    </div>
    
    <div class="calendar-grid" id="calendarGrid">
        <!-- æ—¥å†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="mood-selector" id="moodSelector" style="display: none;">
        <h3>Select Mood</h3>
        <div class="emoji-options">
            <button class="emoji-btn" data-emoji="ğŸ˜Š">ğŸ˜Š Happy</button>
            <button class="emoji-btn" data-emoji="ğŸ˜¢">ğŸ˜¢ Sad</button>
            <button class="emoji-btn" data-emoji="ğŸ˜Œ">ğŸ˜Œ Calm</button>
            <button class="emoji-btn" data-emoji="ğŸ˜¤">ğŸ˜¤ Angry</button>
            <button class="emoji-btn" data-emoji="ğŸ˜°">ğŸ˜° Anxious</button>
            <button class="emoji-btn" data-emoji="ğŸ¤”">ğŸ¤” Thoughtful</button>
            <button class="emoji-btn" data-emoji="ğŸ˜´">ğŸ˜´ Tired</button>
            <button class="emoji-btn" data-emoji="ğŸ¥³">ğŸ¥³ Excited</button>
        </div>
        <button id="autoAnalyze" class="btn-secondary">Auto Analyze Mood</button>
        <button id="closeSelector" class="btn-close">Close</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let selectedDate = null;
let moodData = {};

// åˆå§‹åŒ–
function init() {
    renderCalendar();
    loadMonthMoods();
    
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
        loadMonthMoods();
    });
    
    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
        loadMonthMoods();
    });
    
    document.getElementById('closeSelector').addEventListener('click', () => {
        document.getElementById('moodSelector').style.display = 'none';
    });
    
    document.querySelectorAll('.emoji-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const emoji = btn.dataset.emoji;
            setMood(selectedDate, emoji);
        });
    });
    
    document.getElementById('autoAnalyze').addEventListener('click', () => {
        autoAnalyzeMood(selectedDate);
    });
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('monthYear').textContent = 
        `${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    let html = '<div class="weekdays">';
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        html += `<div class="weekday">${day}</div>`;
    });
    html += '</div><div class="days">';
    
    // ç©ºç™½æ—¥æœŸ
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="day empty"></div>';
    }
    
    // å®é™…æ—¥æœŸ
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const mood = moodData[dateStr];
        const isToday = dateStr === new Date().toISOString().split('T')[0];
        
        html += `
            <div class="day ${isToday ? 'today' : ''}" data-date="${dateStr}">
                <span class="day-number">${day}</span>
                ${mood ? `<span class="mood-emoji">${mood.mood_emoji}</span>` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    
    document.getElementById('calendarGrid').innerHTML = html;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.day:not(.empty)').forEach(dayEl => {
        dayEl.addEventListener('click', () => {
            selectedDate = dayEl.dataset.date;
            document.getElementById('moodSelector').style.display = 'block';
        });
    });
}

async function loadMonthMoods() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    
    try {
        const response = await fetch(`/api/mood/month?year=${year}&month=${month}`);
        const data = await response.json();
        
        if (data.success) {
            moodData = {};
            data.moods.forEach(m => {
                moodData[m.date] = m;
            });
            renderCalendar();
        }
    } catch (error) {
        console.error('åŠ è½½å¿ƒæƒ…æ•°æ®å¤±è´¥:', error);
    }
}

async function setMood(date, emoji) {
    try {
        const response = await fetch('/api/mood/set', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ date, mood_emoji: emoji })
        });
        
        const data = await response.json();
        
        if (data.success) {
            moodData[date] = { date, mood_emoji: emoji };
            renderCalendar();
            document.getElementById('moodSelector').style.display = 'none';
        }
    } catch (error) {
        alert('è®¾ç½®å¿ƒæƒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

async function autoAnalyzeMood(date) {
    try {
        const response = await fetch('/api/mood/auto-analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ date })
        });
        
        const data = await response.json();
        
        if (data.success) {
            moodData[date] = { date: data.date, mood_emoji: data.mood_emoji };
            renderCalendar();
            document.getElementById('moodSelector').style.display = 'none';
            alert(`è‡ªåŠ¨åˆ†æå®Œæˆï¼ä»Šæ—¥å¿ƒæƒ…ï¼š${data.mood_emoji}`);
        } else {
            alert(data.error || 'è‡ªåŠ¨åˆ†æå¤±è´¥');
        }
    } catch (error) {
        alert('è‡ªåŠ¨åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

init();
</script>
{% endblock %}
