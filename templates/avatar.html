{% extends "base.html" %}

{% block title %}é€‰æ‹© Avatar - MindMate{% endblock %}

{% block content %}
<div class="container" style="padding-bottom: 80px;">
    <h1>Choose Your Avatar</h1>
    
    <form id="avatarForm" enctype="multipart/form-data">
        <div class="section">
            <h2>å½¢è±¡å¤–è§‚</h2>
            
            <div class="appearance-options">
                <label class="appearance-option">
                    <input type="radio" name="appearance_type" value="cute_animal" required>
                    <div class="option-card">
                        <span class="icon">ğŸ±</span>
                        <span class="label">å¯çˆ±åŠ¨ç‰©</span>
                    </div>
                </label>
                
                <label class="appearance-option">
                    <input type="radio" name="appearance_type" value="q_character" required>
                    <div class="option-card">
                        <span class="icon">ğŸ‘§</span>
                        <span class="label">Qç‰ˆäººç‰©</span>
                    </div>
                </label>
                
                <label class="appearance-option">
                    <input type="radio" name="appearance_type" value="custom" required>
                    <div class="option-card">
                        <span class="icon">ğŸ“·</span>
                        <span class="label">è‡ªå®šä¹‰ç…§ç‰‡</span>
                    </div>
                </label>
            </div>
            
            <div id="customImageUpload" class="form-group" style="display: none;">
                <label>ä¸Šä¼  Avatar å¤´åƒï¼ˆä½ çš„ AI ä¼™ä¼´çš„å½¢è±¡ï¼‰</label>
                <div class="avatar-upload">
                    <img id="avatarPreview" src="/static/images/default-avatar.png" alt="Avatar Preview" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 10px 0; border: 3px solid #667eea;">
                    <input type="file" id="custom_image" name="custom_image" accept="image/*">
                    <label for="custom_image" class="upload-btn">é€‰æ‹© Avatar å¤´åƒ</label>
                </div>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">è¿™æ˜¯ä½ çš„ AI ä¼™ä¼´çš„å¤´åƒï¼Œä¸æ˜¯ä½ è‡ªå·±çš„å¤´åƒ</p>
            </div>
        </div>
        
        <div class="section">
            <h2>å½¢è±¡å†…æ ¸ (Persona)</h2>
            
            <div id="personasList" class="persona-options">
                <!-- åŠ¨æ€åŠ è½½ Personas -->
            </div>
            
            <div id="customPersonaInput" class="form-group" style="display: none;">
                <label for="custom_persona">è‡ªå®šä¹‰æ€§æ ¼æè¿°</label>
                <textarea id="custom_persona" name="custom_persona" rows="4" placeholder="æè¿°ä½ å¸Œæœ› Avatar æ‹¥æœ‰çš„æ€§æ ¼å’Œè¯´è¯æ–¹å¼..."></textarea>
            </div>
        </div>
        
        <button type="submit" class="btn-primary">Confirm Selection</button>
    </form>
    
    <div id="message" class="message"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let personas = [];

// åŠ è½½ Personas
async function loadPersonas() {
    try {
        const response = await fetch('/api/avatar/personas');
        const data = await response.json();
        
        if (data.success) {
            personas = data.personas;
            renderPersonas();
        }
    } catch (error) {
        console.error('åŠ è½½ Personas å¤±è´¥:', error);
    }
}

function renderPersonas() {
    const container = document.getElementById('personasList');
    container.innerHTML = personas.map(p => `
        <label class="persona-option">
            <input type="radio" name="persona_id" value="${p.id}" required>
            <div class="option-card">
                <h3>${p.name}</h3>
                <p>${p.description}</p>
            </div>
        </label>
    `).join('');
    
    // ç›‘å¬ Persona é€‰æ‹©
    document.querySelectorAll('input[name="persona_id"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const personaId = parseInt(e.target.value);
            const isUserDefined = personas.find(p => p.id === personaId && p.name === 'User-defined');
            document.getElementById('customPersonaInput').style.display = isUserDefined ? 'block' : 'none';
        });
    });
}

// ç›‘å¬å¤–è§‚ç±»å‹é€‰æ‹©
document.querySelectorAll('input[name="appearance_type"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        const uploadSection = document.getElementById('customImageUpload');
        uploadSection.style.display = e.target.value === 'custom' ? 'block' : 'none';
    });
});

// Avatar å¤´åƒé¢„è§ˆ
document.getElementById('custom_image').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// æäº¤è¡¨å•
document.getElementById('avatarForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'ä¿å­˜ä¸­...';
    submitBtn.disabled = true;
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/api/avatar/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('âœ… Avatar é…ç½®æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
            setTimeout(() => {
                window.location.href = '/chat';
            }, 1500);
        } else {
            showMessage('âŒ ' + (data.error || 'é…ç½®å¤±è´¥'), 'error');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        showMessage('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

function showMessage(text, type) {
    const messageEl = document.getElementById('message');
    messageEl.textContent = text;
    messageEl.className = 'message ' + type;
}

loadPersonas();
</script>
{% endblock %}
