{% extends "base.html" %}

{% block title %}个人资料 - MindMate{% endblock %}

{% block content %}
<div class="container" style="padding-bottom: 80px;">
    <h1>User Profile</h1>
    
    <form id="profileForm">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" value="{{ profile.name or '' }}" placeholder="Enter your name">
        </div>
        
        <div class="form-group">
            <label for="gender">Gender</label>
            <select id="gender" name="gender">
                <option value="" {% if not profile.gender %}selected{% endif %}>Prefer not to say</option>
                <option value="male" {% if profile.gender == 'male' %}selected{% endif %}>Male</option>
                <option value="female" {% if profile.gender == 'female' %}selected{% endif %}>Female</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="date_birth">Date of Birth</label>
            <input type="date" id="date_birth" name="date_birth" value="{{ profile.date_birth or '' }}">
        </div>
        
        <div class="form-group">
            <label for="goal">Goal / Motto</label>
            <input type="text" id="goal" name="goal" placeholder="What's your life motto?" value="{{ profile.goal or '' }}">
        </div>
        
        <div class="form-group">
            <label for="self_description">Self Description</label>
            <textarea id="self_description" name="self_description" rows="4" placeholder="Please describe yourself, your personality or identity...">{{ profile.self_description or '' }}</textarea>
        </div>
        
        <button type="submit" class="btn-primary">Save</button>
        <button type="button" class="btn-secondary" onclick="logout()" style="margin-left: 10px;">Log Out</button>
    </form>
    
    <div id="message" class="message"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 提交表单
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/api/profile/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('Saved successfully!', 'success');
        } else {
            showMessage(data.error || 'Save failed', 'error');
        }
    } catch (error) {
        showMessage('Network error, please try again', 'error');
    }
});

function showMessage(text, type) {
    const messageEl = document.getElementById('message');
    messageEl.textContent = text;
    messageEl.className = 'message ' + type;
}

// 登出功能
function logout() {
    if (confirm('Are you sure you want to log out?')) {
        console.log('[Logout] Starting logout process...');
        
        // 立即清除本地数据
        sessionStorage.clear();
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_id');
        localStorage.removeItem('username');
        
        console.log('[Logout] Local storage cleared');
        
        // 调用后端登出 API（不等待响应）
        const token = localStorage.getItem('auth_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        // 异步调用，不阻塞跳转
        fetch('/api/auth/logout', {
            method: 'POST',
            headers: headers
        }).catch(error => {
            console.error('[Logout] API error (ignored):', error);
        });
        
        // 立即跳转到登录页
        console.log('[Logout] Redirecting to login page...');
        window.location.replace('/login');
    }
}
</script>
{% endblock %}